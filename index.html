<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>æ‰¹é‡è‡ªåŠ¨é¢†å–å·¥å…·</title>
  <style>
    body { background: #1a1a1a; color: #e5ffe5; font-family: "Consolas", "Menlo", monospace; padding: 32px; }
    h2 { color: #93ff6f; }
    textarea, input { width: 100%; margin-top: 10px; background: #222; color: #8ffe8f; border: 1px solid #444; border-radius: 4px; padding: 8px; font-size: 15px; }
    button { background: #59dd75; color: #111; border: none; border-radius: 4px; padding: 10px 32px; margin-top: 16px; font-weight: bold; cursor: pointer; }
    button:active { background: #338744; }
    #output { white-space: pre-wrap; margin-top: 28px; background: #181818; border: 1px solid #2a2a2a; border-radius: 8px; min-height: 200px; padding: 14px; font-size: 15px; }
    .txhash { color: #ffe066; font-weight: bold; }
    .fail { color: #ff5e5e; }
    .heartbeat { color: #27bbff; }
    .success { color: #6cff70; }
    .section-title { font-weight:bold; color:#ffe066; font-size: 17px; margin: 16px 0 4px 0;}
    .copy-btn { background: #ffe066; color: #111; margin-left: 8px; border-radius: 4px; padding: 6px 14px; font-size:14px; cursor:pointer;}
    .copy-btn:active { background: #ccbe57; }
    .count-label { color:#6cff70; margin-bottom:5px; font-size: 14px; }
    .count-label span { color: #ffe066; }
    .count-warn { color: #ff5e5e; font-weight:bold; margin-left:10px;}
  </style>
</head>
<body>
  <h2>æ‰¹é‡è‡ªåŠ¨é¢†å–å·¥å…·</h2>
  <form id="mainForm" autocomplete="off">
    <label>é’±åŒ…åœ°å€ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰:</label><br>
    <textarea id="addresses" rows="5" placeholder="0x..."></textarea><br>
    <div id="addresses_count" class="count-label"></div>

    <label>ä»£ç†åˆ—è¡¨ï¼ˆip:port:user:pass[:SOCKS5]ï¼‰:</label><br>
    <textarea id="proxies" rows="5" placeholder="ip:ç«¯å£:è´¦å·:å¯†ç  æˆ– ip:ç«¯å£:è´¦å·:å¯†ç :SOCKS5"></textarea><br>
    <div id="proxies_count" class="count-label"></div>

    <label>YesCaptcha API Key:</label><br>
    <input id="clientKey" placeholder="API Key"><br>
    <button type="submit">å¼€å§‹é¢†å–</button>
    <button type="button" id="btn-query">æŸ¥è¯¢å†å²ç»“æœ</button>
    <button type="button" class="copy-btn" id="btn-copy-fail">å¤åˆ¶å¤±è´¥åœ°å€</button>
  </form>
  <div id="output"></div>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      function updateCounts() {
        const a = document.getElementById("addresses").value.trim().split('\n').filter(l=>l.trim());
        const aUnique = [...new Set(a)];
        const p = document.getElementById("proxies").value.trim().split('\n').filter(l=>l.trim());
        const pUnique = [...new Set(p)];
        let warnA = a.length !== aUnique.length ? `<span class="count-warn">æœ‰é‡å¤</span>` : '';
        let warnP = p.length !== pUnique.length ? `<span class="count-warn">æœ‰é‡å¤</span>` : '';
        document.getElementById("addresses_count").innerHTML =
          `åœ°å€æ•°é‡ï¼š<span>${a.length}</span>ï¼Œå”¯ä¸€ï¼š<span>${aUnique.length}</span> ${warnA}`;
        document.getElementById("proxies_count").innerHTML =
          `ä»£ç†æ•°é‡ï¼š<span>${p.length}</span>ï¼Œå”¯ä¸€ï¼š<span>${pUnique.length}</span> ${warnP}`;
      }
      document.getElementById("addresses").addEventListener('input', updateCounts);
      document.getElementById("proxies").addEventListener('input', updateCounts);
      updateCounts();

      const output = document.getElementById("output");

      function addLine(line) {
        line = line
          .replace(/é¢†å–æˆåŠŸï¼Txhash: <span class='txhash'>([^<]+)<\/span>/g,
              "<span class='success'>ğŸ‰ é¢†å–æˆåŠŸï¼Txhash: <span class='txhash'>$1</span></span>")
          .replace(/^âŒ.*å¤±è´¥.*/gm, txt => `<span class='fail'>${txt}</span>`)
          .replace(/^\[å¿ƒè·³\].*/gm, txt => `<span class='heartbeat'>${txt}</span>`);
        output.innerHTML += line + "\n";
        output.scrollTop = output.scrollHeight;
      }

      document.getElementById("mainForm").onsubmit = async function(e) {
        e.preventDefault();
        output.innerHTML = "å¼€å§‹è¿æ¥...\n";
        window.lastFailLines = "";

        const addresses = document.getElementById("addresses").value;
        const proxies = document.getElementById("proxies").value;
        const clientKey = document.getElementById("clientKey").value;

        const res = await fetch("/run", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ addresses, proxies, client_key: clientKey })
        });
        if (!res.body) {
          output.innerHTML += "âŒ è¯·æ±‚å¤±è´¥ï¼";
          return;
        }
        const reader = res.body.getReader();
        let decoder = new TextDecoder();
        let partial = '';
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          let chunk = decoder.decode(value, {stream:true});
          partial += chunk;
          let lines = partial.split('\n\n');
          partial = lines.pop();
          lines.forEach(line => {
            const match = /^data:\s*(.*)/.exec(line);
            if (match) addLine(match[1]);
          });
        }
      }

      document.getElementById("btn-query").onclick = async function() {
        output.innerHTML = "æŸ¥è¯¢ä¸­...\n";
        let resp = await fetch('/results');
        let text = await resp.text();
        let succ = [], fail = [];
        text.split('\n').forEach(line => {
          if (line.startsWith("ğŸ‰")) succ.push(line);
          if (line.startsWith("âŒ")) fail.push(line);
        });
        output.innerHTML = `<div class='section-title'>ğŸ‰ æˆåŠŸ</div>${succ.join('<br>') || 'æ— '}<br>
                            <div class='section-title'>âŒ å¤±è´¥ï¼ˆå”¯ä¸€ï¼‰</div>${fail.join('<br>') || 'æ— '}`;
        output.scrollTop = output.scrollHeight;
        window.lastFailLines = fail.map(line=>{
          let m = line.match(/âŒ (\w{42})/); return m ? m[1] : null;
        }).filter(x=>x).join("\n");
      };

      document.getElementById("btn-copy-fail").onclick = function() {
        if (!window.lastFailLines) {
          alert("è¯·å…ˆç‚¹å‡»ã€æŸ¥è¯¢å†å²ç»“æœã€‘å†å¤åˆ¶å”¯ä¸€å¤±è´¥åœ°å€ï¼");
          return;
        }
        navigator.clipboard.writeText(window.lastFailLines).then(()=>{
          alert("å”¯ä¸€å¤±è´¥åœ°å€å·²å¤åˆ¶ï¼");
        });
      };
    });
  </script>
</body>
</html>
